#!/bin/bash

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

set -e
exec 1>&2 # Send any output to stderr, to not alter the action response protocol

# create the override of crowdsec-firewall-bouncer
tmpfile=$(mktemp)
trap "rm -f \${tmpfile}" EXIT
cat <<EOF >${tmpfile}
[Unit]
After=${MODULE_ID}.service

[Service]
Restart=always
ExecStartPre=/usr/local/sbin/firewall-rules create-ipset
ExecStartPost=/usr/local/sbin/firewall-rules add-rule
ExecStopPost=/usr/local/sbin/firewall-rules remove-rule
EOF
mkdir -vp /etc/systemd/system/crowdsec-firewall-bouncer.service.d/
install -v -m 644 "${tmpfile}" /etc/systemd/system/crowdsec-firewall-bouncer.service.d/crowdsec-firewall-bouncer-override.conf

systemctl daemon-reload

# create the firewall wrapper (copy it from bin/firewall-rules)
install -v -m 0755 ../bin/firewall-rules /usr/local/sbin/firewall-rules

systemctl enable --now crowdsec-firewall-bouncer.service
systemctl restart "${MODULE_ID}.service"
