#!/usr/bin/env python3

#
# Copyright (C) 2022 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

import os
import json
import agent
import agent.tasks

from jinja2 import Environment, FileSystemLoader, select_autoescape

# retrieve where crowdsec runs to sort the module for watching only them
node_id = os.environ['NODE_ID']

files =["crowdsec_config/acquis.yaml"]
for f in files:
    try:
        os.remove(f)
    except FileNotFoundError:
        pass

jenv = Environment(
    loader=FileSystemLoader(os.getenv("AGENT_INSTALL_DIR")+"/templates"),
    autoescape=select_autoescape(),
    keep_trailing_newline=True,
)

rdb = agent.redis_connect()
modules=[]

# we list all modules, then we search in which node they run and 
# we filter only relevant module on the node
for kenv in rdb.scan_iter(match='module/*/environment'):
    if rdb.hget(kenv, "NODE_ID") == node_id:
        modules.append(kenv.removeprefix("module/").removesuffix("/environment"))

properties = {
    "modules" : modules
}

template = jenv.get_template('acquis.yaml')
output = template.render(properties)
with open("crowdsec_config/acquis.yaml","w") as f:
    f.write(output)

# The first start crowdsec expects other configuration files
# if these files are not present then the service fails to start
# we start the first time with the default configuration
if os.path.isfile("crowdsec_config/config.yaml"):
    files =["crowdsec_config/config.yaml"]
    for f in files:
        try:
            os.remove(f)
        except FileNotFoundError:
            pass

    jenv = Environment(
        loader=FileSystemLoader(os.getenv("AGENT_INSTALL_DIR")+"/templates"),
        autoescape=select_autoescape(),
        keep_trailing_newline=True,
    )
    # placeholder for later
    properties = {}

    template = jenv.get_template('config.yaml')
    output = template.render(properties)
    with open("crowdsec_config/config.yaml","w") as f:
        f.write(output)


# expand profiles.yaml.local
smtp = agent.get_smarthost_settings(agent.redis_connect())

files =["crowdsec_config/profiles.yaml.local"]
for f in files:
    try:
        os.remove(f)
    except FileNotFoundError:
        pass

properties = {
    "email": smtp['enabled'],
    "bantime": os.environ.get('BANTIME','1m'),
    "dyn_bantime": os.environ.get('DYN_BANTIME',True),
    "dyn_ban_value": '%d' + ''.join(filter(lambda x: not x.isdigit(), os.environ.get('BANTIME','1m')))
}
template = jenv.get_template('profiles.yaml.local')
output = template.render(properties)
with open("crowdsec_config/profiles.yaml.local","w") as f:
    f.write(output)
