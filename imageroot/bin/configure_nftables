#!/bin/bash

#
# Copyright (C) 2025 Nethesis S.r.l.
# SPDX-License-Identifier: GPL-3.0-or-later
#

# prepare nftables for crowdsec since it is not more privileged

table_exists() {
     nft list tables | grep -q "$1"
}

set_exists() {
     nft list sets | grep -q "$2"
}

chain_exists() {
     nft list chain "$1" "$2" "$3" | grep -q "chain $3"
}

# verify if the table exists
if ! table_exists "crowdsec"; then
     nft add table ip crowdsec
fi

if ! table_exists "crowdsec6"; then
     nft add table ip6 crowdsec6
fi

# create CAPI blacklist
if ! set_exists "ip" "crowdsec-blacklists-CAPI"; then
     nft add set ip crowdsec crowdsec-blacklists-CAPI { type ipv4_addr\; flags timeout\; elements = {} }
fi

if ! set_exists "ip6" "crowdsec6-blacklists-CAPI"; then
     nft add set ip6 crowdsec6 crowdsec6-blacklists-CAPI { type ipv6_addr\; flags timeout\; elements = {} }
fi

# create LAPI blacklist
if ! set_exists "ip" "crowdsec-blacklists-crowdsec"; then
     nft add set ip crowdsec crowdsec-blacklists-crowdsec { type ipv4_addr\; flags timeout\; elements = {} }
fi

if ! set_exists "ip6" "crowdsec6-blacklists-crowdsec"; then
     nft add set ip6 crowdsec6 crowdsec6-blacklists-crowdsec { type ipv6_addr\; flags timeout\; elements = {} }
fi

# verify if the chain exists
if ! chain_exists "ip" "crowdsec" "crowdsec-chain-input"; then
     nft add chain ip crowdsec crowdsec-chain-input { type filter hook input priority filter - 10\; policy accept\; }
fi

if ! chain_exists "ip" "crowdsec" "crowdsec-chain-forward"; then
     nft add chain ip crowdsec crowdsec-chain-forward { type filter hook forward priority filter - 10\; policy accept\; }
fi

if ! chain_exists "ip6" "crowdsec6" "crowdsec6-chain-input"; then
     nft add chain ip6 crowdsec6 crowdsec6-chain-input { type filter hook input priority filter - 10\; policy accept\; }
fi

if ! chain_exists "ip6" "crowdsec6" "crowdsec6-chain-forward"; then
     nft add chain ip6 crowdsec6 crowdsec6-chain-forward { type filter hook forward priority filter - 10\; policy accept\; }
fi

# add rules
 nft add rule ip crowdsec crowdsec-chain-input counter
 nft add rule ip crowdsec crowdsec-chain-forward counter
 nft add rule ip6 crowdsec6 crowdsec6-chain-input counter
 nft add rule ip6 crowdsec6 crowdsec6-chain-forward counter

 nft add rule ip crowdsec crowdsec-chain-input ip saddr @crowdsec-blacklists-CAPI counter drop
 nft add rule ip crowdsec crowdsec-chain-forward ip saddr @crowdsec-blacklists-CAPI counter drop
 nft add rule ip6 crowdsec6 crowdsec6-chain-input ip6 saddr @crowdsec6-blacklists-CAPI counter drop
 nft add rule ip6 crowdsec6 crowdsec6-chain-forward ip6 saddr @crowdsec6-blacklists-CAPI counter drop
